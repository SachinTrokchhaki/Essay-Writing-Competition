{% extends 'custom_admin/base.html' %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: #e3f2fd; color: #1976d2;">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-value">{{ total_users }}</div>
            <div class="stat-label">Total Users</div>
            <small class="text-success">+{{ new_users_today }} today</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: #e8f5e9; color: #388e3c;">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-value">{{ total_competitions }}</div>
            <div class="stat-label">Active Competitions</div>
            <small class="text-warning">{{ upcoming_competitions }} upcoming</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: #fff3e0; color: #f57c00;">
                <i class="fas fa-pen"></i>
            </div>
            <div class="stat-value">{{ total_essays }}</div>
            <div class="stat-label">Total Essays</div>
            <small class="text-info">{{ pending_essays }} pending review</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon" style="background: #fce4ec; color: #c2185b;">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-value">{{ accepted_essays }}</div>
            <div class="stat-label">Accepted Essays</div>
            <small>{{ acceptance_rate }}% acceptance rate</small>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="table-container">
            <h5>Weekly Submissions</h5>
            <canvas id="submissionsChart"></canvas>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="table-container">
            <h5>Competition Status</h5>
            <canvas id="competitionChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="table-container">
            <h5>Recent Essays</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>User</th>
                        <th>Status</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for essay in recent_essays %}
                    <tr>
                        <td>{{ essay.title|truncatechars:30 }}</td>
                        <td>{{ essay.user.username }}</td>
                        <td>
                            <span class="badge badge-{{ feedback.status }}">
                                {{ feedback.get_status_display }}
                            </span>
                        </td>
                        <td>
                            {% if essay.total_score %}
                                {{ essay.total_score|floatformat:1 }}%
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No recent essays</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="table-container">
            <h5>Recent Feedback</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Message</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feedback in recent_feedback %}
                    <tr>
                        <td>{{ feedback.name }}</td>
                        <td>{{ feedback.message|truncatechars:40 }}</td>
                        <td>
                            <span class="badge badge-{{ feedback.status }}">
                                {{ feedback.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <a href="{% url 'custom_admin:feedback' %}?id={{ feedback.id }}" class="action-btn" style="background: #007bff; color: white;">View</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No recent feedback</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Top Performers -->
<div class="row mt-4">
    <div class="col-12">
        <div class="table-container">
            <h5>Top Performing Users</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Essays Submitted</th>
                        <th>Accepted</th>
                        <th>Average Score</th>
                        <th>Success Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in top_users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.essay_count }}</td>
                        <td>{{ user.accepted_count }}</td>
                        <td>{{ user.avg_score|floatformat:1 }}%</td>
                        <td>
                            {% if user.essay_count > 0 %}
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar bg-success" style="width: {{ user.success_rate }}%"></div>
                                </div>
                                <small>{{ user.success_rate|floatformat:1 }}%</small>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Submissions Chart
    const ctx1 = document.getElementById('submissionsChart').getContext('2d');
    new Chart(ctx1, {
        type: 'line',
        data: {
            labels: {{ weekly_labels|safe }},
            datasets: [{
                label: 'Submissions',
                data: {{ weekly_data|safe }},
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Competition Chart
    const ctx2 = document.getElementById('competitionChart').getContext('2d');
    new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['Active', 'Expired', 'Upcoming'],
            datasets: [{
                data: {{ competition_stats|safe }},
                backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
</script>
{% endblock %}